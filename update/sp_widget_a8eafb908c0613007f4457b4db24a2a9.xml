<?xml version="1.0" encoding="UTF-8"?>
<record_update table="sp_widget">
    <sp_widget action="INSERT_OR_UPDATE">
        <category>custom</category>
        <client_script><![CDATA[function() {
  /* widget controller */
  var c = this;
	if (c.options.fields)
		c.cardFields = c.options.fields.split(",");
	c.getPrimaryField = function getPrimaryField(row){
		return row[c.data.primaryField];
	};
}]]></client_script>
        <controller_as>c</controller_as>
        <css>.fields {
  $dl-horizontal-offset: 120px;
  dt {
    font-weight: normal;
    color: $text-muted;
    float: left;
    width: ($dl-horizontal-offset - 20);
    clear: left;
    text-align: right;
    @include text-overflow;
  }
  dd {
    @include clearfix;
    margin-left: $dl-horizontal-offset;
  }
}</css>
        <data_table>x_snc_reusable_wid_card_list_instance</data_table>
        <demo_data>Title, Table, View, Filter, Display Field</demo_data>
        <description/>
        <docs/>
        <field_list>title,table,view,filter,display_field</field_list>
        <has_preview>false</has_preview>
        <id>card-list</id>
        <internal>false</internal>
        <link><![CDATA[function() {
	/* widget controller */
	var c = this;
	if (c.data && c.data.cardFields) {
		c.cardFields = getCardFields(c.data.cardFields, c.data.primaryField);
	}
	
	c.getPrimaryField = function getPrimaryField(row) {
		return row[c.data.primaryField];
	};
	
	function getCardFields(allFields, primaryField) {
		var cardFields = [];
		allFields = allFields.split(",");
		var exclude = [primaryField, c.options.display_field, c.options.priority_field];
		for (var i = allFields.length-1; i>= 0; i--){
			if (exclude.indexOf(allFields[i]) == -1) {
				cardFields.push(allFields[i]);
			}
		}
		return cardFields;
	}
	
	c.getPriority = function(row) {
		if (typeof row[c.options.priority_field] == "undefined") {
			return;
		}
		var p = row[c.options.priority_field];
		var color;
		if (p.indexOf('4') > -1) {
			color = 'green';
		} else if (p.indexOf('3') > -1) {
			color = 'yellow';
		} else if (p.indexOf('2') > -1) {
			color = 'orange';
		} else if (p.indexOf('1') > -1) {
			color = 'red';
		}
		if (color) {
			return {'border-left': '3px solid ' + color};
			}
		}
	}]]></link>
        <name>Card List</name>
        <option_schema>[{"hint":"A field that contains a value 1 - 4 to indicate priority.","name":"priority_field","default_value":"priority","label":"Priority Field","type":"string"}]</option_schema>
        <public>false</public>
        <roles/>
        <script><![CDATA[(function() {
	/* populate the 'data' object */
	/* e.g., data.table = $sp.getValue('table'); */
	
	if (options.table) {
		data.cardFields = $sp.getListColumns(options.table, options.view_dv);
		data.rows = [];
		var gr = new GlideRecord(options.table);
		gr.addEncodedQuery(options.filter);
		gr.setLimit(25);
		gr.query();
		if (!data.primaryField) {
			data.primaryField = gr.getDisplayName();
		}
		var fields = "sys_id," + data.primaryField + "," + data.cardFields;
		data.fields = $sp.getFieldsObject(gr, fields);
		while(gr.next()) {
			var row = {};
				$sp.getRecordDisplayValues(row, gr, fields);
				data.rows.push(row);
			}
		}
	})();]]></script>
        <servicenow>false</servicenow>
        <sys_class_name>sp_widget</sys_class_name>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2018-05-09 21:25:11</sys_created_on>
        <sys_id>a8eafb908c0613007f4457b4db24a2a9</sys_id>
        <sys_mod_count>3</sys_mod_count>
        <sys_name>Card List</sys_name>
        <sys_package display_value="Reusable Widgets" source="x_snc_reusable_wid">cbefa4faf41232007f44717f642a22b4</sys_package>
        <sys_policy/>
        <sys_scope display_value="Reusable Widgets">cbefa4faf41232007f44717f642a22b4</sys_scope>
        <sys_update_name>sp_widget_a8eafb908c0613007f4457b4db24a2a9</sys_update_name>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2018-05-09 21:32:05</sys_updated_on>
        <template><![CDATA[<div>
  <div class="panel panel-default">
    <div class="panel-heading">
      <span class="h3 panel-title">{{::c.options.title}}</span>
    </div>
    <div class="panel-body">
      <div class="list-group" ng-repeat="row in c.data.rows track by row.sys_id">
        <a href="javascript:void(0)" class="list-group-item" ng-style="::c.getPriority(row)">
          <div class="small">{{::c.getPrimaryField(row)}}</div>
          <div class="h4 list-group-item-heading">{{::row[c.options.display_field]}}</div>
          <dl class="fields">
            <span ng-repeat="f in c.cardFields"><dt>{{c.data.fields[f].label}}</dt><dd>{{row[f]}}</dd></span>
          </dl>
        </a>
      </div>
    </div>
  </div>
</div> ]]></template>
    </sp_widget>
</record_update>
